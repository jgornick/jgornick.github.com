<!doctype html>

<html lang="en-us">

<head>
  <title>
    
      Joe Gornick - How to test and wait for React async events
    
  </title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Joe Gornick - How to test and wait for React async events" />
  <meta name="author" content="Joe Gornick" />
  <meta name="generator" content="Hugo 0.57.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/3.0.1/github-markdown.min.css" />
<link rel="stylesheet" type="text/css" href="https://joegornick.com/css/styles.css" />
</head>

<body>
  <div id="container" class="markdown-body">
    <header>
      <h1>
        <a href="https://joegornick.com/">Joe Gornick</a>
      </h1>

      <ul id="social-media">
        
        <li><a href="https://twitter.com/jgornick"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
         
        <li><a href="https://www.linkedin.com/in/jgornick"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
         
        <li><a href="https://github.com/jgornick"><i class="fa fa-github fa-lg" aria-hidden="true"></i></a></li>
         
        <li><a href="https://gitlab.com/jgornick"><i class="fa fa-gitlab fa-lg" aria-hidden="true"></i></a></li>
          
      </ul>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="https://joegornick.com/posts/">
                <i class="fa-li fa  fa-lg"></i><span>Posts</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://joegornick.com/resume/">
                <i class="fa-li fa  fa-lg"></i><span>Resume</span>
            </a>
        </li>
        
    </ul>
</nav>

    <main>




<article>

    <h1>How to test and wait for React async events</h1>

    
        <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2019-08-21T15:07:19-05:00">Aug 21, 2019</time>
        </li>
        
        

        

        <li>2 min read</li>
    </ul>
</aside>
    

    <p>If you are trying to <a href="https://airbnb.io/enzyme/docs/api/ShallowWrapper/simulate.html"><code>simulate</code></a> an event on a React component, and that event&rsquo;s handler is an <code>async</code> method, it&rsquo;s not clear how to wait for the handler to finish before making any assertions.</p>

<p>Initially, one would think that because <code>simulate</code> simply calls the prop on the component, that it would return the result from the handler. However, <code>simulate</code> returns the <code>Wrapper</code> instance for continued chaining.</p>

<p>After doing some initial searches, a couple of proposed approaches would be to wait for the event loop to finish with the async event hander:</p>

<p><a href="https://github.com/airbnb/enzyme/issues/823#issuecomment-384401360">Simulate events returning promises?</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;...&#39;</span>, () <span style="color:#f92672">=&gt;</span> {
    <span style="color:#a6e22e">wrapper</span>.<span style="color:#a6e22e">find</span>(<span style="color:#e6db74">&#39;...&#39;</span>).<span style="color:#a6e22e">simulate</span>(<span style="color:#e6db74">&#39;change&#39;</span>)

    <span style="color:#a6e22e">setImmediate</span>(() <span style="color:#f92672">=&gt;</span> {
        <span style="color:#a6e22e">wrapper</span>.<span style="color:#a6e22e">update</span>()
        <span style="color:#a6e22e">expect</span>(...).<span style="color:#a6e22e">toBe</span>(...)
    })
})</code></pre></div>
<p><a href="https://twitter.com/wesbos/status/973646077802041345">Wes Bos Tweet for Simulating Async Events</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;...&#39;</span>, <span style="color:#a6e22e">async</span> () <span style="color:#f92672">=&gt;</span> {
  <span style="color:#a6e22e">wrapper</span>.<span style="color:#a6e22e">find</span>(...).<span style="color:#a6e22e">simulate</span>(<span style="color:#e6db74">&#39;change&#39;</span>)

  <span style="color:#a6e22e">await</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Promise</span>(<span style="color:#a6e22e">setImmediate</span>)

  <span style="color:#a6e22e">expect</span>(...).<span style="color:#a6e22e">toBe</span>(...)
})</code></pre></div>
<p>Another approach is to use Jest&rsquo;s <a href="https://jestjs.io/docs/en/timer-mocks.html">timer mocks</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;...&#39;</span>, () <span style="color:#f92672">=&gt;</span> {
  <span style="color:#a6e22e">jest</span>.<span style="color:#a6e22e">useFakeTimers</span>()

  <span style="color:#a6e22e">wrapper</span>.<span style="color:#a6e22e">find</span>(...).<span style="color:#a6e22e">simulate</span>(<span style="color:#e6db74">&#39;change&#39;</span>)

  <span style="color:#a6e22e">jest</span>.<span style="color:#a6e22e">runAllTimers</span>()

  <span style="color:#a6e22e">expect</span>(...).<span style="color:#a6e22e">toBe</span>(...)
})</code></pre></div>
<p>A solution that seemed to be a little more in line with existing testing patterns is to <a href="https://jestjs.io/docs/en/jest-object#jestspyonobject-methodname"><code>spyOn</code></a> the handler in the React component and wait for it to resolve:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">waitForSpy</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">async</span> (<span style="color:#a6e22e">spy</span>: <span style="color:#66d9ef">jest.SpyInstance</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Promise</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">unknown</span><span style="color:#f92672">&gt;&gt;</span>) <span style="color:#f92672">=&gt;</span> {
  <span style="color:#a6e22e">expect</span>(<span style="color:#a6e22e">spy</span>).<span style="color:#a6e22e">toHaveBeenCalledTimes</span>(<span style="color:#ae81ff">1</span>)
  <span style="color:#a6e22e">await</span> <span style="color:#a6e22e">spy</span>.<span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">instances</span>[<span style="color:#ae81ff">0</span>]
}

<span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;...&#39;</span>, <span style="color:#a6e22e">async</span> () <span style="color:#f92672">=&gt;</span> {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">spy</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">jest</span>.<span style="color:#a6e22e">spyOn</span>(<span style="color:#a6e22e">wrapper</span>.<span style="color:#a6e22e">instance</span>(), <span style="color:#e6db74">&#39;handleChange&#39;</span>)

  <span style="color:#a6e22e">wrapper</span>.<span style="color:#a6e22e">find</span>(...).<span style="color:#a6e22e">simulate</span>(<span style="color:#e6db74">&#39;change&#39;</span>)

  <span style="color:#a6e22e">await</span> <span style="color:#a6e22e">waitForSpy</span>(<span style="color:#a6e22e">spy</span>)

  <span style="color:#a6e22e">expect</span>(...).<span style="color:#a6e22e">toBe</span>(...)
}</code></pre></div>
<p>The <code>waitForSpy</code> method first expects the spy to have been called at least once. This allows the next line to safely run waiting for the mocked instance returned <code>Promise</code> to resolve.</p>


</article>


  <section class="post-nav">
    <ul>
      
        <li>
            <a href="https://joegornick.com/2019/05/01/publish-a-scoped-package-to-a-custom-registry/"><i class="fa fa-chevron-circle-left"></i> Publish a scoped package to a custom registry</a>
        </li>
      
      
    </ul>
  </section>
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jgornick" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>





    </main>
    <footer>
      <h6>
        Copyright &copy; 2019 - Joe Gornick |
        Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
        <a href="https://joegornick.com/index.xml">Subscribe</a>
      </h6>
    </footer>
  </div>
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-2943070-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  <script src="https://joegornick.com/js/scripts.js"></script>
</body>
</html>